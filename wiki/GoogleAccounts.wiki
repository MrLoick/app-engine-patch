#summary How to activate support for Google Accounts.
#labels OnlyInRepo

= Using Google Accounts =

It's possible to use Google Accounts instead of Django's auth mechanism or alternatively use a hybrid system that supports both authentication methods.

*Only available in repository:*

By default, Google Accounts marked as admins get superuser and staff status. You can turn this off in your settings:
{{{
AUTH_ADMIN_USER_AS_SUPERUSER = False
}}}

== Google Accounts only ==

You just need a few changes in your settings.py:

{{{
# Replace Django's AuthenticationMiddleware with GoogleAuthenticationMiddleware.
MIDDLEWARE_CLASSES = (
    # Note: You don't need the SessionMiddleware for Google Accounts
    ...
    'ragendja.auth.middleware.GoogleAuthenticationMiddleware',
    ...
)

# Change the User model class
AUTH_USER_MODULE = 'ragendja.auth.google_models'
}}}

This will automatically give you a Google-compatible `@login_required` decorator. Note that the default Google `User` model does not have `first_name` and `last_name` properties, but it adds a `user` property of type `db.UserProperty`. Also, the `email` and `username` properties can't be changed or queried with a `filter()` call because they are dynamically retrieved from the `user` property. You can [CustomUserModel define your own] `User` model if you want to change anything.

== Hybrid authentication ==

With hybrid authentication you can use both Google and Django accounts. Just add this to your settings.py:
{{{
# Replace Django's AuthenticationMiddleware with HybridAuthenticationMiddleware.
MIDDLEWARE_CLASSES = (
    ...
    'ragendja.auth.middleware.HybridAuthenticationMiddleware',
    ...
)

# Change the User model class
AUTH_USER_MODULE = 'ragendja.auth.hybrid_models'
}}}

Note that in this case `@login_required` will behave like in Django-only mode (there's still `@ragendja.auth.decorators.google_login_required` if you need it), so you'll have to take care of making both authentication methods visible on your login page. Also, the `User` model has all properties that are defined in Django in addition to a `user` property which can be set to `None`.

= Template tags and context processors =

Add the following to your settings.py:
{{{
# Add google_login_url and google_logout_url tags
GLOBALTAGS = (
    'ragendja.templatetags.googletags',
)
}}}

Alternatively, you can add `'ragendja'` to your `INSTALLED_APPS` and `{% load googletags %}` in your template.

This will add two template tags for creating login and logout urls (`google_login_url` and `google_logout_url`). Both tags can take an optional parameter specifying the redirect URL after login/logout:
{{{
<div class="login">
  {% if user.is_authenticated %}
    Welcome, {{ user.email }}
    <a href="{% google_logout_url %}">Logout</a>
  {% else %}
    <a href="{% google_login_url request.get_full_path %}">Login</a>
  {% endif %}
</div>
}}}

= Distinguishing between auth methods =

*The following is only available in the repository:*

In order to distinguish whether the user logged in via Google or Django and generate the correct logout link you'll need to add the 'google_user' context_processor to your settings:
{{{
TEMPLATE_CONTEXT_PROCESSORS = (
   ...
   'ragendja.auth.context_processors.google_user',
   ...
)
}}}

Then you can generate the correct logout link with this code:
{{{
{% if google_user %}
  <a href="{% google_logout_url %}">Logout</a>
{% else %}
  <a href="{% url django.contrib.auth.views.logout %}">Logout</a>
{% endif %}
}}}